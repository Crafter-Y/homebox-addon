#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Homebox
# Long-running service: starts the Homebox binary with the correct environment.
# ==============================================================================

# Fix: Homebox tries to create temp files under $TMPDIR.
# /tmp is not writable in HA addon containers, so we redirect to /data/tmp.
mkdir -p /data/tmp
chmod 1777 /data/tmp
export TMPDIR="/data/tmp"

# Change to /data so Homebox resolves all relative storage paths
# inside the addon's persistent data directory.
cd /data

# Remove stale SQLite WAL/SHM lock files that can be left behind after a crash.
# Homebox cleans these up on a clean shutdown; only crashes leave them behind.
mkdir -p /data/.data
rm -f /data/.data/*.db-shm /data/.data/*.db-wal

# Override SQLite path: use DELETE journal mode instead of WAL to avoid shared
# memory issues on HA OS Docker volumes, and raise busy_timeout to 30 seconds.
export HBOX_STORAGE_SQLITE_PATH="/data/.data/homebox.db?_pragma=busy_timeout=30000&_pragma=journal_mode=DELETE&_fk=1&_time_format=sqlite"

# Run in production mode (disables developer tooling/debug endpoints).
export HBOX_MODE="production"

# Apply user-configurable options from the HA add-on UI.
export HBOX_LOG_LEVEL="$(bashio::config 'log_level')"
export HBOX_LOG_FORMAT="text"
export HBOX_WEB_MAX_UPLOAD_SIZE="$(bashio::config 'max_upload_size')"
export HBOX_OPTIONS_ALLOW_REGISTRATION="$(bashio::config 'allow_registration')"

# Disable telemetry and self-update checks (not useful in a local HA context).
export HBOX_OPTIONS_ALLOW_ANALYTICS="false"
export HBOX_OPTIONS_GITHUB_RELEASE_CHECK="false"

# Trust reverse-proxy headers if HA is fronted by a proxy, but keep false
# for the default direct-access scenario.
export HBOX_OPTIONS_TRUST_PROXY="false"

bashio::log.info "Starting Homebox..."
exec /usr/bin/homebox
